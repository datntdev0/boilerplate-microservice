# Postman Authentication Setup Guide

This guide explains how to authenticate with the Identity Provider using Postman. The system supports two OAuth2 flows configured via OpenIddict:

1. **Authorization Code Flow with PKCE** - For public clients (SPAs, mobile apps)
2. **Client Credentials Flow** - For confidential clients (service-to-service communication)

## Prerequisites

- Postman installed (Desktop or Web version)
- Identity Provider service running (typically at `https://localhost:7001` or configured URL)
- Database seeded with OpenIddict applications (run Migrator first)

## Configuration Overview

The system seeds two OpenIddict applications during migration:

| Application Type | Client ID Pattern | Flow | Use Case |
|-----------------|-------------------|------|----------|
| Public | `{ClientId}.Public` | Authorization Code + PKCE | User authentication for SPAs/Mobile |
| Confidential | `{ClientId}.Confidential` | Client Credentials | Service-to-service authentication |

### Required Configuration Values

Ensure these values are configured in your `appsettings.json` or User Secrets:

```json
{
  "OpenIddict": {
    "ClientId": "microservice",
    "ClientSecret": "your-secret-key",
    "EncryptionKey": "base64-encoded-key",
    "RedirectUris": "https://oauth.pstmn.io/v1/callback;http://localhost:4200/auth/callback",
    "LogoutRedirectUris": "https://oauth.pstmn.io/v1/callback;http://localhost:4200"
  },
  "DefaultAdmin": {
    "EmailAddress": "admin@example.com",
    "Password": "Admin@123"
  }
}
```

### OAuth2 Endpoints

| Endpoint | URL Path | Purpose |
|----------|----------|---------|
| Authorization | `/connect/authorize` | Initiates authorization code flow |
| Token | `/connect/token` | Exchanges code for tokens or gets client credentials token |
| End Session | `/auth/signout` | Logs out user session |

---

## Method 1: Authorization Code Flow with PKCE (Public Client)

This flow is suitable for user authentication from SPAs, mobile apps, or testing user-based authentication.

### Step 1: Configure OAuth 2.0 in Postman

1. Create a new request or collection
2. Go to the **Authorization** tab
3. Select **OAuth 2.0** as the type
4. Click **Configure New Token** and set:

| Field | Value |
|-------|-------|
| **Token Name** | `Identity Provider Token` |
| **Grant Type** | `Authorization Code (With PKCE)` |
| **Callback URL** | `https://oauth.pstmn.io/v1/callback` |
| **Auth URL** | `https://localhost:7240/connect/authorize` |
| **Access Token URL** | `https://localhost:7240/connect/token` |
| **Client ID** | `datntdev.Microservice.Public` |
| **Client Secret** | *(leave empty for public clients)* |
| **Code Challenge Method** | `SHA-256` |
| **Scope** | *(leave empty or use custom scopes)* |
| **State** | *(auto-generated)* |
| **Client Authentication** | `Send as Basic Auth header` |

### Step 2: Get New Access Token

1. Click **Get New Access Token**
2. A browser window will open to the Identity Provider login page
3. Sign in using the default admin credentials:
   - **Email**: `admin@example.com`
   - **Password**: `Admin@123`
4. After successful authentication, you'll be redirected back to Postman
5. Postman will display the token details
6. Click **Use Token** to apply it to your requests

### Step 3: Use the Token

The access token will be automatically added to the request's `Authorization` header as:

```
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
```

### Token Lifecycle

- **Access Token**: Short-lived (typically 1 hour)
- **Refresh Token**: Not implemented in current configuration
- When the token expires, repeat Step 2 to get a new token

---

## Method 2: Client Credentials Flow (Confidential Client)

This flow is suitable for service-to-service authentication without user context.

### Step 1: Configure OAuth 2.0 in Postman

1. Create a new request or collection
2. Go to the **Authorization** tab
3. Select **OAuth 2.0** as the type
4. Click **Configure New Token** and set:

| Field | Value |
|-------|-------|
| **Token Name** | `Service Token` |
| **Grant Type** | `Client Credentials` |
| **Access Token URL** | `https://localhost:7240/connect/token` |
| **Client ID** | `datntdev.Microservice.Confidential` |
| **Client Secret** | `your-secret-key` *(from configuration)* |
| **Scope** | *(leave empty or use custom scopes)* |
| **Client Authentication** | `Send as Basic Auth header` |

### Step 2: Get New Access Token

1. Click **Get New Access Token**
2. Postman will directly call the token endpoint (no browser interaction)
3. Token will be returned immediately
4. Click **Use Token**

### Step 3: Use the Token

The token is added to requests automatically:

```
Authorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...
```

---

## Manual Token Request (Alternative)

You can also manually request tokens using Postman requests:

### Client Credentials Grant

```http
POST https://localhost:7001/connect/token
Content-Type: application/x-www-form-urlencoded

grant_type=client_credentials
&client_id=microservice.Confidential
&client_secret=your-secret-key
```

**Response:**
```json
{
  "access_token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "Bearer",
  "expires_in": 3600
}
```

---

## Troubleshooting

### Common Issues

#### 1. **Invalid Client Error**

**Error**: `invalid_client` or client not found

**Solution**: 
- Ensure the Migrator has run successfully
- Verify the `ClientId` matches the pattern: `{ClientId}.Public` or `{ClientId}.Confidential`
- Check database table `OpenIddictApplications` for registered clients

#### 2. **Redirect URI Mismatch**

**Error**: `The specified 'redirect_uri' is not valid for this client application`

**Solution**:
- Ensure `https://oauth.pstmn.io/v1/callback` is in the `RedirectUris` configuration
- Run the Migrator again to update the OpenIddict applications

#### 3. **Invalid Grant Error**

**Error**: `invalid_grant`

**Solution**:
- For Authorization Code flow: Ensure you completed the login process
- For Client Credentials: Verify the client secret is correct

#### 4. **Certificate/SSL Issues**

**Error**: SSL certificate validation failed

**Solution**:
- In Postman Settings, disable **SSL certificate verification** for development
- Alternatively, install the development certificate in your trusted root

#### 5. **Token Expired**

**Error**: `401 Unauthorized` on API requests

**Solution**:
- Request a new access token
- Current configuration uses short-lived tokens without refresh tokens

---

## Testing Protected APIs

After obtaining a token, you can test protected endpoints:

### Example: Call Identity Service

```http
GET https://localhost:7002/api/identity/me
Authorization: Bearer {your-access-token}
```

### Example: Call Admin Service

```http
GET https://localhost:7003/api/admin/users
Authorization: Bearer {your-access-token}
```

---

## Security Best Practices

1. **Never commit Client Secrets** - Use User Secrets or environment variables
2. **Use HTTPS** - Always use secure connections in production
3. **Token Storage** - Don't log or expose access tokens
4. **PKCE for Public Clients** - Always enable PKCE for SPAs and mobile apps
5. **Scope Restriction** - Implement and request minimal required scopes
6. **Short Token Lifetimes** - Keep access tokens short-lived (1 hour recommended)

---

## Advanced Configuration

### Adding Custom Scopes

Modify the seeder to include custom scopes:

```csharp
Permissions =
{
    OpenIddictConstants.Permissions.Endpoints.Token,
    OpenIddictConstants.Permissions.Endpoints.Authorization,
    OpenIddictConstants.Permissions.GrantTypes.AuthorizationCode,
    OpenIddictConstants.Permissions.ResponseTypes.Code,
    // Add custom scopes
    OpenIddictConstants.Permissions.Prefixes.Scope + "api.read",
    OpenIddictConstants.Permissions.Prefixes.Scope + "api.write",
}
```

### Refresh Token Support

To enable refresh tokens, update the OpenIddict configuration:

```csharp
options
    .AllowAuthorizationCodeFlow()
    .AllowRefreshTokenFlow(); // Add this line
```

And add the permission to the application descriptor:

```csharp
OpenIddictConstants.Permissions.GrantTypes.RefreshToken
```

---

## References

- [OpenIddict Documentation](https://documentation.openiddict.com/)
- [OAuth 2.0 RFC 6749](https://tools.ietf.org/html/rfc6749)
- [PKCE RFC 7636](https://tools.ietf.org/html/rfc7636)
- [Postman OAuth 2.0 Guide](https://learning.postman.com/docs/sending-requests/authorization/#oauth-20)

---

## Quick Reference: Client IDs

Based on configuration `OpenIddict:ClientId = "microservice"`:

| Client Type | Client ID | Flow |
|-------------|-----------|------|
| Public | `microservice.Public` | Authorization Code + PKCE |
| Confidential | `microservice.Confidential` | Client Credentials |

Update the base client ID in configuration to change all derived client IDs.
